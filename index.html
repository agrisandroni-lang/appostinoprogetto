<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApPostino</title>
    <!-- Tailwind CSS per lo stile -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js per le mappe interattive -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        /* Stile per rendere la mappa a schermo intero e nascondere elementi */
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        .screen { display: none; }
        .screen.active { display: flex; flex-direction: column; height: 100vh; }
        #map-container { flex-grow: 1; position: relative; background-color: #e0e0e0; } /* Aggiunto colore di sfondo e position relative */
        /* Stile personalizzato per i segnaposto */
        .leaflet-marker-icon .marker-label {
            position: absolute;
            bottom: -20px;
            left: -25px;
            width: 50px;
            text-align: center;
            font-weight: bold;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            padding: 2px;
            font-size: 14px;
        }
        .leaflet-marker-icon.nearby {
            filter: hue-rotate(180deg) brightness(1.2);
        }
        .leaflet-marker-icon.nearby .marker-label {
            background-color: gold;
            color: black;
            transform: scale(1.5) translateY(-5px);
        }
        /* Stile per il messaggio di overlay sulla mappa */
        #map-overlay-message {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 1000; /* Assicura che sia sopra la mappa */
            display: none; /* Nascosto di default */
            text-align: center;
            font-size: 14px;
            max-width: 90%;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Schermata 1: Menu Principale -->
    <div id="home-screen" class="screen active justify-center items-center p-5">
        <div class="text-center">
            <h1 class="text-5xl font-bold text-blue-600 mb-2">ApPostino</h1>
            <p class="text-xl text-gray-600 mb-10">La tua mappa personale per le consegne</p>
            <button id="go-to-create" class="w-full bg-blue-600 text-white text-lg font-bold py-3 px-4 rounded-lg shadow-md mb-4 hover:bg-blue-700 transition-colors">
                Crea la tua Mappa
            </button>
            <button id="go-to-list" class="w-full bg-blue-600 text-white text-lg font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                Visualizza le tue mappe
            </button>
             <div id="auth-status" class="mt-8 text-gray-500 text-sm">Accesso in corso...</div>
        </div>
    </div>

    <!-- Schermata 2: Elenco Mappe -->
    <div id="map-list-screen" class="screen">
        <div class="p-4 bg-white shadow-md">
            <button id="back-to-home-from-list" class="text-blue-600 font-semibold">&lt; Torna al Menu</button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mt-2">Le tue Mappe</h2>
        </div>
        <div id="maps-list-container" class="flex-grow p-4 overflow-y-auto">
            <!-- L'elenco delle mappe verrà inserito qui da JavaScript -->
            <p id="no-maps-message" class="text-center text-gray-500 mt-10">Non hai ancora creato nessuna mappa.</p>
        </div>
    </div>

    <!-- Schermata 3: Editor Mappa -->
    <div id="map-editor-screen" class="screen">
        <div id="map-container">
             <div id="map-overlay-message"></div>
        </div>
        <div id="form-container" class="p-3 bg-white shadow-lg">
             <button id="back-to-list-from-editor" class="text-blue-600 font-semibold mb-2">&lt; Torna all'elenco</button>
            <input type="text" id="map-name-input" placeholder="Nome della Mappa (es. Giro Centro)" class="w-full p-2 border border-gray-300 rounded mb-2">
            <input type="text" id="city-input" placeholder="Città" class="w-full p-2 border border-gray-300 rounded mb-2">
            <input type="text" id="street-input" placeholder="Via" class="w-full p-2 border border-gray-300 rounded mb-2">
            <div class="flex items-center">
                <input type="text" id="house-number-input" placeholder="N° Civico" class="flex-grow p-2 border border-gray-300 rounded-l">
                <button id="save-marker-button" class="bg-green-500 text-white font-bold py-2 px-4 rounded-r hover:bg-green-600 transition-colors">
                    + Salva
                </button>
            </div>
            <p id="info-text" class="text-center text-blue-600 italic mt-2 text-sm"></p>
        </div>
    </div>
    
    <!-- Modale di Conferma Generica -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-2000">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-4">
            <p id="confirm-modal-title" class="text-lg font-semibold mb-2"></p>
            <p id="confirm-modal-subtitle" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-confirm" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded hover:bg-gray-400">Annulla</button>
                <button id="confirm-action" class="bg-red-600 text-white font-bold py-2 px-6 rounded hover:bg-red-700">Conferma</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import da Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAZIONE FIREBASE ---
        // IMPORTANTE: Sostituisci questo blocco con la configurazione del TUO progetto Firebase!
        // La trovi in: Console Firebase > Impostazioni Progetto > Generale > SDK setup and configuration > Config
        const firebaseConfig =  {
  apiKey: "AIzaSyAghAxidhGMa5sQRZHrO0MFHHLtOWp_yX4",
  authDomain: "mappapostino.firebaseapp.com",
  projectId: "mappapostino",
  storageBucket: "mappapostino.firebasestorage.app",
  messagingSenderId: "944815179156",
  appId: "1:944815179156:web:0cd86ba2be9eb0f909fb81"
};
            
        // --- FINE CONFIGURAZIONE FIREBASE ---

        const appId = firebaseConfig.appId; // Usa l'appId dalla tua configurazione
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- VARIABILI GLOBALI E STATO DELL'APP ---
        let map;
        let userMarker;
        let temporaryMarker;
        let currentMarkers = [];
        let currentMapData = null;
        let unsubscribeMapListener = null;
        let unsubscribeMapsListListener = null;
        let repositioningState = { active: false, markerId: null };

        // --- DOM ELEMENTS ---
        const screens = {
            home: document.getElementById('home-screen'),
            mapList: document.getElementById('map-list-screen'),
            mapEditor: document.getElementById('map-editor-screen')
        };
        const buttons = {
            goToCreate: document.getElementById('go-to-create'),
            goToList: document.getElementById('go-to-list'),
            backToHomeFromList: document.getElementById('back-to-home-from-list'),
            backToListFromEditor: document.getElementById('back-to-list-from-editor'),
            saveMarker: document.getElementById('save-marker-button'),
        };
        const inputs = {
            mapName: document.getElementById('map-name-input'),
            city: document.getElementById('city-input'),
            street: document.getElementById('street-input'),
            houseNumber: document.getElementById('house-number-input'),
        };
        const containers = {
            mapList: document.getElementById('maps-list-container'),
        };
        const infoText = document.getElementById('info-text');
        const authStatus = document.getElementById('auth-status');

        // --- NAVIGAZIONE ---
        const showScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
        };
        
        // --- MODALE DI CONFERMA ---
        const showConfirm = (title, subtitle, onConfirmCallback) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-subtitle').textContent = subtitle;
            modal.style.display = 'flex';
                        
            document.getElementById('confirm-action').onclick = () => {
                onConfirmCallback();
                modal.style.display = 'none';
            };
            document.getElementById('cancel-confirm').onclick = () => {
                 modal.style.display = 'none';
            };
        }

        // --- LOGICA MAPPA (LEAFLET) ---
        const initMap = (coords) => {
            if (map) {
                map.setView([coords.latitude, coords.longitude], 16);
                return;
            };
            map = L.map('map-container').setView([coords.latitude, coords.longitude], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Listener per posizionare o riposizionare un segnaposto
            map.on('click', async (e) => {
                if (repositioningState.active) {
                    await finishRepositioning(e.latlng);
                    return;
                }

                 if (currentMapData && currentMapData.mode === 'view') return;
                
                if (temporaryMarker) {
                    map.removeLayer(temporaryMarker);
                }
                temporaryMarker = L.circleMarker(e.latlng, {
                    radius: 8, color: 'red', weight: 3, fillColor: '#f03', fillOpacity: 0.5
                }).addTo(map);
                infoText.textContent = 'Segnaposto posizionato. Inserisci il civico e salva.';
            });

            // Listener per gestire i click sui pulsanti nel popup
            map.on('popupopen', (e) => {
                const popupNode = e.popup._container;
                const deleteBtn = popupNode.querySelector('.delete-marker-btn');
                if (deleteBtn) {
                    deleteBtn.onclick = () => {
                        const markerId = deleteBtn.dataset.markerId;
                        showConfirm('Eliminare questo segnaposto?', 'L\'azione è irreversibile.', () => handleDeleteMarker(markerId));
                    };
                }

                const moveBtn = popupNode.querySelector('.move-marker-btn');
                if (moveBtn) {
                    moveBtn.onclick = () => {
                        const markerId = moveBtn.dataset.markerId;
                        startRepositioning(markerId);
                    };
                }
            });
        };

        const updateUserLocation = (coords) => {
             if (!map) return;
             
             if (!userMarker) {
                 userMarker = L.circleMarker([coords.latitude, coords.longitude], { radius: 8, color: 'blue', fillColor: '#3498db', fillOpacity: 1 }).addTo(map);
             } else {
                 userMarker.setLatLng([coords.latitude, coords.longitude]);
             }

             if(currentMapData && currentMapData.mode === 'view') {
                map.panTo([coords.latitude, coords.longitude]);
             }
             checkNearbyMarkers(coords);
        };
        
        const clearMarkers = () => {
             if (!map) return;
             currentMarkers.forEach(m => map.removeLayer(m));
             currentMarkers = [];
        }

        const renderMarkers = (markers) => {
            if (!map) return;
            clearMarkers();
            markers.forEach(markerData => {
                 const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div class="marker-label">${markerData.houseNumber}</div>`,
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                });
                const popupContent = `
                    <b>${markerData.street}, ${markerData.houseNumber}</b><br>
                    ${markerData.city}<br><br>
                    <div class="flex justify-around gap-2">
                        <button class="delete-marker-btn bg-red-500 text-white text-xs py-1 px-2 rounded" data-marker-id="${markerData.id}">Elimina</button>
                        <button class="move-marker-btn bg-blue-500 text-white text-xs py-1 px-2 rounded" data-marker-id="${markerData.id}">Sposta</button>
                    </div>
                `;
                const marker = L.marker([markerData.latitude, markerData.longitude], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(popupContent);
                marker.markerData = markerData;
                currentMarkers.push(marker);
            });
        };
        
        const getDistance = (coord1, coord2) => {
            if (!coord1 || !coord2) return Infinity;
            const toRad = x => (x * Math.PI) / 180;
            const R = 6371e3; // Raggio Terra in metri
            const φ1 = toRad(coord1.latitude);
            const φ2 = toRad(coord2.latitude);
            const Δφ = toRad(coord2.latitude - coord1.latitude);
            const Δλ = toRad(coord2.longitude - coord1.longitude);

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        };

        const checkNearbyMarkers = (userCoords) => {
            currentMarkers.forEach(marker => {
                const distance = getDistance(userCoords, marker.getLatLng());
                const markerIconEl = marker.getElement();
                if (markerIconEl) {
                    if (distance < 50) {
                        markerIconEl.classList.add('nearby');
                    } else {
                        markerIconEl.classList.remove('nearby');
                    }
                }
            });
        };

        // --- GEOLOCALIZZAZIONE ---
        const startWatchingLocation = () => {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => updateUserLocation(position.coords),
                    (error) => console.error("Errore geolocalizzazione:", error.code, error.message),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        };

        // --- LOGICA FIREBASE E DATI ---
        const attachMapListener = (mapId) => {
            const userId = auth.currentUser?.uid;
            if (!userId) return;
            if (unsubscribeMapListener) unsubscribeMapListener();

            const mapRef = doc(db, `artifacts/${appId}/users/${userId}/maps`, mapId);
            unsubscribeMapListener = onSnapshot(mapRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentMapData = { ...currentMapData, ...data };
                    renderMarkers(data.markers || []);
                    if (currentMapData.mode !== 'create' && data.markers && data.markers.length > 0) {
                        const lastMarker = data.markers[data.markers.length - 1];
                        inputs.city.value = lastMarker.city;
                        inputs.street.value = lastMarker.street;
                    }
                }
            });
        };

        const loadMapsList = (userId) => {
            if (unsubscribeMapsListListener) unsubscribeMapsListListener();
            containers.mapList.innerHTML = '<p class="text-center text-gray-500">Caricamento mappe...</p>';
            
            const mapsCollectionPath = `artifacts/${appId}/users/${userId}/maps`;
            const q = query(collection(db, mapsCollectionPath));

            unsubscribeMapsListListener = onSnapshot(q, (snapshot) => {
                containers.mapList.innerHTML = '';
                if (snapshot.empty) {
                     containers.mapList.innerHTML = '<p class="text-center text-gray-500 mt-10">Non hai ancora creato nessuna mappa.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const map = { id: doc.id, ...doc.data() };
                        const mapDiv = document.createElement('div');
                        mapDiv.className = 'bg-white p-4 rounded-lg shadow mb-3';
                        mapDiv.innerHTML = `
                            <h3 class="text-xl font-bold mb-3">${map.name}</h3>
                            <div class="flex justify-around">
                                <button data-id="${map.id}" class="view-btn bg-green-500 text-white font-semibold py-1 px-3 rounded hover:bg-green-600">Visualizza</button>
                                <button data-id="${map.id}" class="edit-btn bg-yellow-400 text-white font-semibold py-1 px-3 rounded hover:bg-yellow-500">Modifica</button>
                                <button data-id="${map.id}" data-name="${map.name}" class="delete-btn bg-red-500 text-white font-semibold py-1 px-3 rounded hover:bg-red-600">Elimina</button>
                            </div>
                        `;
                        containers.mapList.appendChild(mapDiv);
                    });
                }
            }, (error) => {
                 console.error("Errore nello snapshot listener di Firestore:", error);
                 containers.mapList.innerHTML = '<p class="text-center text-red-500">Errore nel caricamento delle mappe.</p>';
            });
        };
        
        const openMapEditor = (mode, mapId = null) => {
            currentMapData = { mode, mapId };
            
            inputs.mapName.value = ''; inputs.city.value = '';
            inputs.street.value = ''; inputs.houseNumber.value = '';
            infoText.textContent = 'Tocca la mappa per posizionare un segnaposto.';
            
            if (temporaryMarker && map) {
                map.removeLayer(temporaryMarker);
                temporaryMarker = null;
            }
            if (unsubscribeMapListener) unsubscribeMapListener();

            if (!map) {
                const defaultCoords = { latitude: 43.464, longitude: 13.074 }; // Rosora
                initMap(defaultCoords);
            }

            if (mode === 'create') {
                inputs.mapName.style.display = 'block';
                document.getElementById('form-container').style.display = 'block';
                renderMarkers([]);
            } else { 
                inputs.mapName.style.display = 'none';
                attachMapListener(mapId);
                document.getElementById('form-container').style.display = mode === 'view' ? 'none' : 'block';
            }
            showScreen('mapEditor');
            setTimeout(() => { if (map) map.invalidateSize(); }, 100);
        };

        const handleSaveMarker = async () => {
             if (!temporaryMarker) return alert("Prima posiziona un segnaposto sulla mappa toccandola.");
             if (!inputs.houseNumber.value) return alert("Inserisci il numero civico.");
             if (!currentMapData.mapId && !inputs.mapName.value) return alert("Dai un nome alla tua mappa prima di salvare il primo segnaposto.");

            const userId = auth.currentUser.uid;
            const newMarker = {
                id: Date.now().toString(),
                latitude: temporaryMarker.getLatLng().lat, longitude: temporaryMarker.getLatLng().lng,
                city: inputs.city.value, street: inputs.street.value, houseNumber: inputs.houseNumber.value,
            };
            
            const mapsCollectionPath = `artifacts/${appId}/users/${userId}/maps`;
            try {
                if (currentMapData.mapId) {
                    const updatedMarkers = [...(currentMapData.markers || []), newMarker];
                    await setDoc(doc(db, mapsCollectionPath, currentMapData.mapId), { markers: updatedMarkers }, { merge: true });
                } else {
                    const docRef = await addDoc(collection(db, mapsCollectionPath), {
                        name: inputs.mapName.value, createdAt: new Date(), markers: [newMarker],
                    });
                    currentMapData.mapId = docRef.id;
                    inputs.mapName.style.display = 'none';
                    attachMapListener(docRef.id);
                }
                inputs.houseNumber.value = '';
                map.removeLayer(temporaryMarker);
                temporaryMarker = null;
                infoText.textContent = 'Segnaposto salvato! Tocca per posizionarne un altro.';
            } catch(error) {
                console.error("Errore salvataggio: ", error);
                alert("Impossibile salvare il segnaposto.");
            }
        };

        const handleDeleteMarker = async (markerId) => {
            const userId = auth.currentUser.uid;
            const mapsCollectionPath = `artifacts/${appId}/users/${userId}/maps`;
            const updatedMarkers = currentMapData.markers.filter(m => m.id !== markerId);
            await setDoc(doc(db, mapsCollectionPath, currentMapData.mapId), { markers: updatedMarkers }, { merge: true });
            map.closePopup();
        };
        
        const startRepositioning = (markerId) => {
            repositioningState = { active: true, markerId: markerId };
            map.closePopup();
            infoText.textContent = 'MODALITÀ SPOSTAMENTO: Clicca sulla nuova posizione.';
            document.getElementById('map-container').style.cursor = 'crosshair';
        };

        const finishRepositioning = async (newLatLng) => {
            const { markerId } = repositioningState;
            const userId = auth.currentUser.uid;
            const mapsCollectionPath = `artifacts/${appId}/users/${userId}/maps`;
            const updatedMarkers = currentMapData.markers.map(marker => 
                marker.id === markerId ? { ...marker, latitude: newLatLng.lat, longitude: newLatLng.lng } : marker
            );
            await setDoc(doc(db, mapsCollectionPath, currentMapData.mapId), { markers: updatedMarkers }, { merge: true });
            repositioningState = { active: false, markerId: null };
            infoText.textContent = 'Segnaposto riposizionato! Tocca per posizionarne un altro.';
            document.getElementById('map-container').style.cursor = '';
        };

        // --- GESTIONE EVENTI ---
        buttons.goToCreate.onclick = () => openMapEditor('create');
        buttons.goToList.onclick = () => showScreen('mapList');
        buttons.backToHomeFromList.onclick = () => showScreen('home');
        buttons.backToListFromEditor.onclick = () => {
            if(unsubscribeMapListener) unsubscribeMapListener();
            currentMapData = null;
            showScreen('mapList');
        };
        buttons.saveMarker.onclick = handleSaveMarker;

        containers.mapList.addEventListener('click', (e) => {
            const target = e.target;
            const mapId = target.dataset.id;
            const userId = auth.currentUser?.uid;
            if (!mapId || !userId) return;

            if (target.classList.contains('view-btn')) openMapEditor('view', mapId);
            if (target.classList.contains('edit-btn')) openMapEditor('edit', mapId);
            if (target.classList.contains('delete-btn')) {
                const mapName = target.dataset.name;
                showConfirm(
                    `Sei sicuro di voler eliminare la mappa "${mapName}"?`,
                    'Tutti i dati della mappa andranno persi per sempre.',
                    async () => {
                        const mapPath = `artifacts/${appId}/users/${userId}/maps`;
                        await deleteDoc(doc(db, mapPath, mapId));
                    }
                );
            }
        });

        // --- INIZIALIZZAZIONE APP ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authStatus.textContent = `Connesso come utente: ${user.uid.substring(0, 8)}...`;
                authStatus.classList.remove('text-red-500');
                authStatus.classList.add('text-green-600');
                loadMapsList(user.uid);
                startWatchingLocation();
            } else {
                authStatus.textContent = "Nessun utente connesso.";
            }
        });

        // Prova a connettere l'utente
        signInAnonymously(auth).catch(error => {
            console.error("Errore di accesso anonimo:", error);
            authStatus.textContent = "Errore di connessione al database. Controlla la configurazione.";
            authStatus.classList.add('text-red-500');
        });

    </script>
</body>
</html>
